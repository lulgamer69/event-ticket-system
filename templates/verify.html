<!DOCTYPE html>
<html>
<head>
    <title>Verify Ticket - Dumblebdor Kindergarten</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<div class="container">

    <div class="header">
        <img src="{{ url_for('static', filename='images/logo.png') }}" class="logo">
        <h1>Ticket Verification</h1>
        <p>Scan or Enter Ticket Number</p>
    </div>

    <div class="content">

        {% if error %}
        <div class="error-message">{{ error }}</div>
        {% endif %}

        {% if record %}
        <div class="success-message">
            âœ… ENTRY GRANTED
        </div>

        <div class="card">
            <p><b>Student:</b> {{ record.child_name }}</p>
            <p><b>Roll No:</b> {{ record.child_roll }}</p>
            <p><b>Ticket:</b> {{ record.ticket_number }}</p>
            <p><b>Parents:</b> {{ record.parent1_name }}{% if record.parent2_name %}, {{ record.parent2_name }}{% endif %}</p>
            <p><b>Allowed People:</b> {{ record.total_people }}</p>
        </div>
        {% endif %}

        <!-- CAMERA SCAN -->
        <div class="section">
            <h3>ðŸ“· Scan QR using Camera</h3>
            <button id="startCam" class="button">Start Camera</button>
            <div id="reader" style="display:none;"></div>
            <button id="stopCam" class="button secondary" style="display:none;">Stop</button>
        </div>

        <hr>

        <!-- MANUAL ENTRY -->
        <form method="POST">
            <h3>ðŸ”¢ Manual Ticket Entry</h3>
            <input type="text" name="ticket_number"
                   placeholder="EVT-2026-XXXXXX" required>
            <button class="button">Verify Ticket</button>
        </form>

    </div>
</div>

<script>
let scanner = null;

document.getElementById("startCam").onclick = () => {
    document.getElementById("reader").style.display = "block";
    document.getElementById("startCam").style.display = "none";
    document.getElementById("stopCam").style.display = "inline-block";

    scanner = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(cameras => {
        scanner.start(
            cameras[cameras.length - 1].id,
            { fps: 10, qrbox: 250 },
            qrText => {
                scanner.stop();
                const form = document.createElement("form");
                form.method = "POST";
                const input = document.createElement("input");
                input.name = "ticket_number";
                input.value = qrText;
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        );
    });
};

document.getElementById("stopCam").onclick = () => {
    if (scanner) scanner.stop();
    document.getElementById("reader").style.display = "none";
    document.getElementById("startCam").style.display = "inline-block";
    document.getElementById("stopCam").style.display = "none";
};
</script>

</body>
</html>
